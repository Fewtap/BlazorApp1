@page "/test"
@using Microsoft.AspNetCore.Components
@using FlightData;
@using Syncfusion.Blazor;
@implements IDisposable;


<input type="date" @onchange="DateChanged" value="@_selectedDate.ToString("yyyy-MM-dd")"/>

<select @onchange="FlightChanged">
    @if(flights != null)
    {
        foreach (var flight in flights.FindAll(f => f.Planned.Date == _selectedDate.Date))
        {
            <option value="@flight.Rute">@flight.ArrivalAirport</option>
        }
    }
    
</select>


<input type="text" @bind="InputValue" @oninput="UpdateInputValue" @onkeydown="SubmitEvent" placeholder="Enter room numbers, separated by commas"/>




@code {
    string InputValue = "";

    void UpdateInputValue(ChangeEventArgs e)
    {
    // Update the InputValue property with the latest input value
        InputValue = e.Value.ToString();
    }
    
    void SubmitEvent(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrEmpty(InputValue))
        {
			var rooms = InputValue.Split(',').Select(r => r.Trim()).ToList();
            Console.WriteLine(rooms.Count.ToString());
			var flight = flights.Find(f => f.FlightHash == _selectedFlight.FlightHash);
            List<Room> roomstoinsert = new List<Room>();
            foreach (var room in rooms)
            {
                roomstoinsert.Add(new Room(room, flight.FlightHash));
            }
            Task.Run(() => FlightDB.PostRoom(roomstoinsert));
			InputValue = "";
		}

    // Update the component to reflect the changes
            InvokeAsync(StateHasChanged);


            
        }
    }


}






@code {

    public Timer timer;
    string _ruteString = "";
    DateTime _selectedDate = DateTime.Now;
    Flight _selectedFlight = new();
    List<Flight> flights = null!;
    FlightDB flightDB = new();
    string _roomString;
    InputDate<DateTime> help = new();
    List<Flight> newflights;

    protected override async void OnInitialized()
    {
        var title = "Getting Data";
        timer = new Timer(UpdatePage, null, 0, 20);
        _selectedDate = DateTime.UtcNow.Subtract(TimeSpan.FromHours(3)).AddDays(1);
        while (FlightDB.IsGettingData)
        {
            await Task.Delay(100);
            



        }
        flights = await FlightDB.GetFlights(_selectedDate);
        



        

        InvokeAsync(StateHasChanged);
        

        _selectedFlight = flights.First(f => f.Planned.Date == _selectedDate.Date);
        _ruteString = _selectedFlight.Rute;
        if (_selectedFlight != null)
        {
            Console.WriteLine(_selectedFlight.Rute + " " + _selectedFlight.ArrivalAirport);
        }
    }


    void FlightChanged(ChangeEventArgs args)
    {
        _selectedFlight = flights.Find(f => f.Planned.Date == _selectedDate.Date && f.Rute == args.Value.ToString());
        if (_selectedFlight != null)
        {
            Console.WriteLine(_selectedFlight.Rute + " " + _selectedFlight.ArrivalAirport);
        }
    }

    void DateChanged(ChangeEventArgs args)
    {
        _selectedDate = DateTime.Parse(args.Value.ToString());
        _selectedFlight = flights.First(f => f.Planned.Date == _selectedDate.Date);
        Console.WriteLine(_selectedDate.ToShortDateString());
        if (_selectedFlight != null)
        {
            Console.WriteLine(_selectedFlight.Rute + " " + _selectedFlight.ArrivalAirport);
        }
    }


    async void UpdatePage(object _)
    {
        if (FlightDB.IsGettingData)
        {
            return;
        }

        List<Flight> newFlights;
        newFlights = await FlightDB.GetFlights(_selectedDate);
        if(newFlights != null)
        {
            flights = newFlights;
        }


        InvokeAsync(StateHasChanged);
    }


    public void Dispose()
    {
        timer.Dispose();
    }



}